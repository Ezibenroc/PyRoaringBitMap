name: Release

on:
    push:
        tags: ['*']

jobs:
    sdist:
        name: Source release
        runs-on: ubuntu-latest
        steps:
        - name: Set up the repository
          uses: actions/checkout@v2
          with:
              submodules: recursive
              fetch-depth: 0
        - name: Set up Python
          uses: actions/setup-python@v1
          with:
              python-version: 3.7
        - name: Install dependencies
          run: |
            pip install --upgrade pip
            pip install --upgrade --upgrade-strategy eager 'Cython>=0.29.21' wheel twine
            pip freeze
        - name: Build the package
          run: |
              python setup.py sdist
        - name: Publish on Github
          uses: svenstaro/upload-release-action@v2
          with:
              repo_token: ${{ secrets.GITHUB_TOKEN }}
              file: dist/*
              overwrite: true
              file_glob: true
              tag: ${{ github.ref }}
        - name: Publish on Pypi
          uses: pypa/gh-action-pypi-publish@v1.4.2
          with:
            user: __token__
            password: ${{ secrets.TEST_PYPI_API_TOKEN }}
            repository_url: https://test.pypi.org/legacy/
